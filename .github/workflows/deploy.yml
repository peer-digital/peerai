name: Manual Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3  # @note: GitHub's official checkout action - do not change URL
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install frontend dependencies
        run: |
          cd frontend/admin-dashboard
          npm ci
      
      - name: Build frontend
        run: |
          cd frontend/admin-dashboard
          npm run build
      
      - name: Create deployment package
        run: |
          mkdir -p deploy-package
          cp -r backend deploy-package/
          cp -r frontend/admin-dashboard/dist deploy-package/backend/static/admin-dashboard/
          cp -r scripts deploy-package/
          cp -r deployment deploy-package/
          tar -czf deploy-package.tar.gz deploy-package/
      
      - name: Upload deployment package
        uses: actions/upload-artifact@v3
        with:
          name: deploy-package
          path: deploy-package.tar.gz

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Download deployment package
        uses: actions/download-artifact@v3
        with:
          name: deploy-package
          path: deploy-package
      
      - name: Set default repository values
        run: |
          # Set hardcoded values for the correct repository
          echo "GITHUB_REPO_OWNER=peer-digital" >> $GITHUB_ENV
          echo "REPO_NAME=peerai" >> $GITHUB_ENV
          echo "Using hardcoded repository: peer-digital/peerai"
      
      - name: Extract repository name (for reference only)
        run: |
          # Extract repository name from full repository path
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d '/' -f 2)
          echo "Repository owner: ${{ github.repository_owner }}"
          echo "Full repository: ${{ github.repository }}"
          echo "Repository name: $REPO_NAME"
          echo "NOTE: Using hardcoded repository peer-digital/peerai for deployment"
      
      - name: Verify GitHub token
        run: |
          # For public repositories, we don't need to verify repository access with a token
          # Just check if the repository exists
          echo "Testing repository access..."
          REPO_PATH="${{ env.GITHUB_REPO_OWNER }}/${{ env.REPO_NAME }}"
          echo "Checking access to repository: $REPO_PATH"
          if curl -s "https://api.github.com/repos/${REPO_PATH}" | grep -q "\"name\":"; then
            echo "✅ Repository access confirmed"
          else
            echo "❌ Cannot access repository"
            echo "Please ensure the repository exists at https://github.com/${REPO_PATH}"
            exit 1
          fi
      
      - name: Make scripts executable
        run: |
          chmod +x ./deploy-package/scripts/*.sh
      
      - name: Transfer deployment package via SCP
        uses: appleboy/scp-action@v0.1.4  # @note: Reliable SCP action for GitHub Actions
        with:
          host: 158.174.210.91
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "deploy-package/*"
          target: "/home/ubuntu/peer-ai"
          strip_components: 1
          # Disable host key checking to handle host key changes
          use_insecure_cipher: true
      
      - name: Ensure scripts are executable
        uses: appleboy/ssh-action@v1.0.0  # @note: Reliable SSH action for GitHub Actions
        with:
          host: 158.174.210.91
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Disable host key checking to handle host key changes
          use_insecure_cipher: true
          script: |
            chmod +x /home/ubuntu/peer-ai/scripts/*.sh
            echo "Made all scripts executable"
      
      - name: Run diagnostic script
        uses: appleboy/ssh-action@v1.0.0  # @note: Reliable SSH action for GitHub Actions
        with:
          host: 158.174.210.91
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Disable host key checking to handle host key changes
          use_insecure_cipher: true
          script: |
            chmod +x /home/ubuntu/peer-ai/scripts/diagnose_ssh.sh
            /home/ubuntu/peer-ai/scripts/diagnose_ssh.sh
      
      - name: Setup VM if needed
        uses: appleboy/ssh-action@v1.0.0  # @note: Reliable SSH action for GitHub Actions
        with:
          host: 158.174.210.91
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Disable host key checking to handle host key changes
          use_insecure_cipher: true
          script: |
            [ -d /home/ubuntu/peer-ai ] || /home/ubuntu/peer-ai/scripts/setup_vm.sh
      
      - name: Setup SSH keys
        uses: appleboy/ssh-action@v1.0.0  # @note: Reliable SSH action for GitHub Actions
        with:
          host: 158.174.210.91
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Disable host key checking to handle host key changes
          use_insecure_cipher: true
          script: |
            /home/ubuntu/peer-ai/scripts/setup_ssh.sh
      
      - name: Setup GitHub authentication
        uses: appleboy/ssh-action@v1.0.0  # @note: Reliable SSH action for GitHub Actions
        with:
          host: 158.174.210.91
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Disable host key checking to handle host key changes
          use_insecure_cipher: true
          envs: GITHUB_REPO_OWNER,REPO_NAME
          script: |
            # Debug environment variables
            echo "GITHUB_REPO_OWNER: ${GITHUB_REPO_OWNER}"
            echo "REPO_NAME: ${REPO_NAME}"
            
            # Use explicit environment variables with the correct repository information
            # No token needed for public repositories
            GITHUB_USER="${GITHUB_REPO_OWNER}" GITHUB_REPO="${REPO_NAME}" /home/ubuntu/peer-ai/scripts/setup_github_auth.sh
        env:
          GITHUB_REPO_OWNER: ${{ env.GITHUB_REPO_OWNER }}
          REPO_NAME: ${{ env.REPO_NAME }}
      
      - name: Fix permissions
        uses: appleboy/ssh-action@v1.0.0  # @note: Reliable SSH action for GitHub Actions
        with:
          host: 158.174.210.91
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Disable host key checking to handle host key changes
          use_insecure_cipher: true
          script: |
            /home/ubuntu/peer-ai/scripts/fix_permissions.sh
      
      - name: Run deployment script
        uses: appleboy/ssh-action@v1.0.0  # @note: Reliable SSH action for GitHub Actions
        with:
          host: 158.174.210.91
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Disable host key checking to handle host key changes
          use_insecure_cipher: true
          script: |
            cd /home/ubuntu/peer-ai && ./scripts/deploy.sh
      
      - name: Fix database migrations
        uses: appleboy/ssh-action@v1.0.0  # @note: Reliable SSH action for GitHub Actions
        with:
          host: 158.174.210.91
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Disable host key checking to handle host key changes
          use_insecure_cipher: true
          script: |
            chmod +x /home/ubuntu/peer-ai/scripts/fix_migration.sh
            cd /home/ubuntu/peer-ai && /home/ubuntu/peer-ai/scripts/fix_migration.sh
      
      - name: Fix constraint issue
        uses: appleboy/ssh-action@v1.0.0  # @note: Reliable SSH action for GitHub Actions
        with:
          host: 158.174.210.91
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Disable host key checking to handle host key changes
          use_insecure_cipher: true
          script: |
            chmod +x /home/ubuntu/peer-ai/scripts/fix_constraint_issue.sh
            cd /home/ubuntu/peer-ai && /home/ubuntu/peer-ai/scripts/fix_constraint_issue.sh || echo "Constraint fix script failed, but continuing deployment"
      
      - name: Test database connection
        uses: appleboy/ssh-action@v1.0.0  # @note: Reliable SSH action for GitHub Actions
        with:
          host: 158.174.210.91
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Disable host key checking to handle host key changes
          use_insecure_cipher: true
          script: |
            chmod +x /home/ubuntu/peer-ai/scripts/ssh_to_db.sh
            chmod +x /home/ubuntu/peer-ai/scripts/test_db.sh
            chmod +x /home/ubuntu/peer-ai/scripts/test_db_connection.py
            cd /home/ubuntu/peer-ai && /home/ubuntu/peer-ai/scripts/test_db.sh
      
      - name: Run pre-migration checks
        uses: appleboy/ssh-action@v1.0.0  # @note: Reliable SSH action for GitHub Actions
        with:
          host: 158.174.210.91
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Disable host key checking to handle host key changes
          use_insecure_cipher: true
          script: |
            chmod +x /home/ubuntu/peer-ai/scripts/pre_migration_checker.sh
            cd /home/ubuntu/peer-ai && /home/ubuntu/peer-ai/scripts/pre_migration_checker.sh || echo "Pre-migration check failed, but continuing deployment"
      
      - name: Initialize database
        uses: appleboy/ssh-action@v1.0.0  # @note: Reliable SSH action for GitHub Actions
        with:
          host: 158.174.210.91
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Disable host key checking to handle host key changes
          use_insecure_cipher: true
          script: |
            cd /home/ubuntu/peer-ai && ./scripts/init_db_auto.sh
      
      - name: Run fix scripts
        uses: appleboy/ssh-action@v1.0.0  # @note: Reliable SSH action for GitHub Actions
        with:
          host: 158.174.210.91
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Disable host key checking to handle host key changes
          use_insecure_cipher: true
          script: |
            cd /home/ubuntu/peer-ai && ./scripts/debug_migrations.sh || echo "Debug migrations script failed, continuing"
            cd /home/ubuntu/peer-ai && ./scripts/fix_github_actions.sh || echo "Fix GitHub Actions script failed, continuing"
            cd /home/ubuntu/peer-ai && ./scripts/fix_frontend_build.sh || echo "Fix frontend build script failed, continuing"
      
      - name: Check deployment status
        uses: appleboy/ssh-action@v1.0.0  # @note: Reliable SSH action for GitHub Actions
        with:
          host: 158.174.210.91
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Disable host key checking to handle host key changes
          use_insecure_cipher: true
          script: |
            cd /home/ubuntu/peer-ai && ./scripts/check_deployment.sh 