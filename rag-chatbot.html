<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Chatbot</title>
    <style>
        :root {
            --primary-color: #1a56db;
            --secondary-color: #4f46e5;
            --background-color: #f9fafb;
            --text-color: #111827;
            --light-bg-color: #f0f7ff;
            --border-color: #e5e7eb;
            --font-family: system-ui, sans-serif;
            --font-size-small: 14px;
            --font-size-medium: 16px;
            --font-size-large: 22px;
            --border-radius: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .app-title {
            font-size: var(--font-size-large);
            font-weight: bold;
            color: var(--primary-color);
        }

        .app-description {
            font-size: var(--font-size-small);
            color: var(--text-color);
            opacity: 0.8;
            margin-top: 5px;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .content-header {
            padding: 15px 20px;
            background-color: var(--primary-color);
            color: white;
        }

        .content-title {
            font-size: var(--font-size-medium);
            font-weight: bold;
        }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 15px 20px;
            background-color: var(--light-bg-color);
            border-bottom: 1px solid var(--border-color);
        }

        .quick-action {
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 8px 15px;
            font-size: var(--font-size-small);
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-action:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .chat-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 12px 15px;
            border-radius: var(--border-radius);
            font-size: var(--font-size-medium);
            line-height: 1.5;
        }

        .ai-message {
            align-self: flex-start;
            background-color: var(--light-bg-color);
            border-bottom-left-radius: 0;
        }

        .user-message {
            align-self: flex-end;
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 0;
        }

        .input-container {
            display: flex;
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            background-color: white;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius) 0 0 var(--border-radius);
            font-size: var(--font-size-medium);
            outline: none;
        }

        .chat-input:focus {
            border-color: var(--primary-color);
        }

        .send-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            padding: 0 20px;
            font-size: var(--font-size-medium);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .send-button:hover {
            background-color: var(--secondary-color);
        }

        .footer {
            text-align: center;
            margin-top: 20px;
            font-size: var(--font-size-small);
            color: var(--text-color);
            opacity: 0.7;
        }

        /* Source citation styles */
        .sources-container {
            margin-top: 10px;
            border-top: 1px solid var(--border-color);
            padding-top: 8px;
            font-size: var(--font-size-small);
        }

        .sources-toggle {
            display: flex;
            align-items: center;
            cursor: pointer;
            color: var(--primary-color);
            font-weight: 500;
            margin-bottom: 5px;
        }

        .sources-toggle:hover {
            text-decoration: underline;
        }

        .sources-list {
            display: none;
            margin-left: 5px;
        }

        .sources-list.expanded {
            display: block;
        }

        .source-item {
            margin-bottom: 8px;
            padding: 8px;
            background-color: rgba(0, 0, 0, 0.03);
            border-radius: var(--border-radius);
            cursor: pointer;
        }

        .source-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .source-name {
            font-weight: 500;
            color: var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .source-content {
            white-space: pre-wrap;
            font-family: var(--font-family);
            font-size: 13px;
            max-height: 200px;
            overflow-y: auto;
            line-height: 1.5;
        }

        .source-content code {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }

        .source-chunks-container {
            display: none;
            margin-top: 8px;
        }

        .source-chunks-container.expanded {
            display: block;
        }

        .source-chunk {
            margin-bottom: 8px;
            padding: 8px;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
        }

        .chunk-header {
            font-weight: 500;
            color: var(--primary-color);
            margin-bottom: 5px;
            font-size: 12px;
        }

        .sources-explanation {
            margin-bottom: 12px;
            padding: 8px;
            background-color: rgba(0, 0, 0, 0.02);
            border-radius: var(--border-radius);
            font-size: 13px;
            color: var(--text-color);
            line-height: 1.4;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
                height: 100vh;
            }

            .quick-actions {
                padding: 10px;
            }

            .message {
                max-width: 90%;
            }
        }
    </style>
<meta name="server-url" content="http://localhost:8000" />
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <div class="app-title">RAG Chatbot</div>
                <div class="app-description">An advanced chatbot solution that can answer questions based on your uploaded documents.</div>
            </div>
        </div>

        <!-- Content section -->
        <div class="content">
            <div class="content-header">
                <div class="content-title">Try it yourself</div>
            </div>

            <!-- Quick actions -->
            <div class="quick-actions">
                <button class="quick-action">What are the main topics in my documents?</button>
                <button class="quick-action">Summarize the key points</button>
                <button class="quick-action">Find information about...</button>
                <button class="quick-action">Compare and contrast...</button>
                <button class="quick-action">Explain the concept of...</button>
            </div>

            <!-- Chat container -->
            <div class="chat-container" id="chat-container">
                <div class="message ai-message">
                    Hello! I'm here to help you. What would you like to know about your documents?
                </div>
            </div>

            <!-- Input section -->
            <div class="input-container">
                <input type="text" class="chat-input" id="user-input" placeholder="Type your question here...">
                <button class="send-button" id="send-button">Send</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration from template
        let API_KEY = 'pk_VBAxUh2HZZyIjC4alk7aLU5-vh8OsNlt79LFfXqGvUE';
        const MODEL = 'mistral-large-latest';
        const TEMPERATURE = 0.7;
        const SYSTEM_PROMPT = `You are a helpful, friendly assistant that answers questions based on the provided document context. When answering, use the information from the documents when available. If the answer is not in the documents, say so clearly and provide a general response based on your knowledge.`;

        // Helper function to determine API base URL
        const getApiBaseUrl = () => {
            console.log('Determining API base URL...');
            console.log('Window location:', window.location.href);
            console.log('Is in iframe:', window !== window.parent);

            // SPECIAL CASE: If we're in a srcdoc iframe, we need to use the backend server directly
            if (window.location.href.startsWith('about:srcdoc')) {
                console.log('Detected srcdoc iframe, using backend server directly');
                return 'http://localhost:8000';
            }

            // Check if we're in an iframe (deployed app)
            if (window !== window.parent) {
                // We're in an iframe, use the parent's origin
                try {
                    // This will throw an error if cross-origin
                    const parentOrigin = window.parent.location.origin;
                    console.log('Using parent origin:', parentOrigin);

                    // If parent is on port 3000, switch to 8000 for API calls
                    if (parentOrigin.includes('localhost:3000')) {
                        console.log('Parent is on frontend server, switching to backend server');
                        return 'http://localhost:8000';
                    }

                    return parentOrigin;
                } catch (e) {
                    // If we can't access parent origin, use the backend server
                    console.log('Cannot access parent origin, using backend server');
                    return 'http://localhost:8000';
                }
            }

            // Check if we're in a production environment
            if (window.location.hostname !== 'localhost') {
                console.log('In production environment, using current origin:', window.location.origin);
                return window.location.origin;
            }

            // In development, always use localhost:8000 (backend server)
            console.log('In development environment, using backend server');
            return 'http://localhost:8000';
        };

        // Get app ID from URL path
        const getAppIdFromPath = () => {
            const pathParts = window.location.pathname.split('/');
            const slug = pathParts[pathParts.length - 1];
            return slug;
        };

        // Get the app ID from the template
        let APP_ID = '56';
        console.log('App ID from template:', APP_ID);

        // If the app_id is still a template placeholder (not replaced), get it from the URL
        if (APP_ID === '56' || APP_ID.includes('{{') || APP_ID.includes('}}')) {
            console.log('App ID is a template placeholder, trying to get it from URL');

            // Try to extract from URL path
            const urlPath = window.location.pathname;
            console.log('Current URL path:', urlPath);

            // First try to extract using regex to find rag-chatbot-XXX pattern
            const chatbotRegex = /rag-chatbot-(\d+)/;
            const chatbotMatch = urlPath.match(chatbotRegex);

            if (chatbotMatch && chatbotMatch[1]) {
                // We found a match like rag-chatbot-123, extract just the number
                APP_ID = chatbotMatch[1]; // Use the captured group (just the number)
                console.log('Extracted numeric app ID from URL path using regex:', APP_ID);
            } else {
                // Try to extract from URL query parameters
                const urlParams = new URLSearchParams(window.location.search);
                const appIdParam = urlParams.get('app_id');

                if (appIdParam && !isNaN(parseInt(appIdParam, 10))) {
                    APP_ID = appIdParam;
                    console.log('Using app_id from URL query parameter:', APP_ID);
                } else {
                    // Try to get from parent URL if in iframe
                    try {
                        if (window !== window.parent) {
                            const parentUrl = new URL(document.referrer);
                            const parentPath = parentUrl.pathname;
                            const parentMatch = parentPath.match(/rag-chatbot-(\d+)/);

                            if (parentMatch && parentMatch[1]) {
                                APP_ID = parentMatch[1];
                                console.log('Extracted app ID from parent URL:', APP_ID);
                            }
                        }
                    } catch (e) {
                        console.warn('Error accessing parent URL:', e);
                    }

                    // If still no valid app ID, try localStorage
                    if (APP_ID === '56' || APP_ID.includes('{{') || APP_ID.includes('}}')) {
                        const storedAppId = localStorage.getItem('rag_app_id');
                        if (storedAppId && !isNaN(parseInt(storedAppId, 10))) {
                            APP_ID = storedAppId;
                            console.log('Using app ID from localStorage:', APP_ID);
                        } else {
                            // Don't use a hardcoded default - try to extract from URL path
                            const pathMatch = window.location.pathname.match(/rag-chatbot-(\d+)/);
                            if (pathMatch && pathMatch[1]) {
                                APP_ID = pathMatch[1];
                                console.log('Using app ID extracted from URL path as fallback:', APP_ID);
                            } else {
                                console.warn('Could not determine app ID from any source. RAG functionality may not work correctly.');
                            }
                        }
                    }
                }
            }

            // Store in localStorage for future use
            if (APP_ID && APP_ID !== '56' && !APP_ID.includes('{{') && !APP_ID.includes('}}')) {
                localStorage.setItem('rag_app_id', APP_ID);
            }
        }

        // Check if we have an API key
        console.log('Initial API key:', API_KEY ? (API_KEY.substring(0, 4) + '...') : 'none');

        // If no API key is available or it's still a template placeholder, try to get it from localStorage
        if (!API_KEY ||
            API_KEY === 'pk_VBAxUh2HZZyIjC4alk7aLU5-vh8OsNlt79LFfXqGvUE' ||
            API_KEY.includes('{{') ||
            API_KEY.includes('}}')) {

            // Try to get the API key from localStorage (for development/testing)
            const storedApiKey = localStorage.getItem('rag_api_key');
            if (storedApiKey) {
                console.log('Using API key from localStorage');
                API_KEY = storedApiKey;
            } else {
                console.warn('No API key available. Some features may not work correctly.');
                // For testing purposes, you can uncomment the following line to prompt for an API key
                // const promptedKey = prompt('Please enter your API key:');
                // if (promptedKey) {
                //     API_KEY = promptedKey;
                //     localStorage.setItem('rag_api_key', promptedKey);
                // }
            }
        }

        // Log configuration for debugging
        console.log('App configuration loaded:');
        console.log('- App ID:', APP_ID);
        console.log('- Model:', MODEL);
        console.log('- API Key available:', !!API_KEY &&
                                    API_KEY !== 'pk_VBAxUh2HZZyIjC4alk7aLU5-vh8OsNlt79LFfXqGvUE' &&
                                    !API_KEY.includes('{{') &&
                                    !API_KEY.includes('}}'));

        // Force the API base URL to be the backend server
        let apiBaseUrl = getApiBaseUrl();
        const isInIframe = window !== window.parent;

        // IMPORTANT: Make sure we're using the backend server (port 8000) for API calls
        // This is a critical fix for the RAG functionality
        if (apiBaseUrl.includes('localhost:3000')) {
            console.log('Detected frontend server URL, switching to backend server');
            apiBaseUrl = 'http://localhost:8000';
        }

        console.log('Using API base URL:', apiBaseUrl);

        // Construct the API URLs
        const COMPLETIONS_API_URL = `${apiBaseUrl}/api/v1/llm/completions`;
        const RAG_API_URL = `${apiBaseUrl}/api/v1/llm/rag`;

        // Construct the documents API URL using the app ID
        let DOCUMENTS_API_URL;

        if (APP_ID && APP_ID !== '56' && !APP_ID.includes('{{') && !APP_ID.includes('}}')) {
            // Use the new app_id endpoint
            DOCUMENTS_API_URL = `${apiBaseUrl}/api/v1/documents/app/id/${APP_ID}`;
            console.log('Documents API URL (using app_id):', DOCUMENTS_API_URL);
        } else {
            console.warn('No valid app ID available for document retrieval');
            DOCUMENTS_API_URL = null;
        }

        // DOM elements
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const quickActions = document.querySelectorAll('.quick-action');

        // Add event listeners
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Add event listeners to quick action buttons
        quickActions.forEach(button => {
            button.addEventListener('click', function() {
                userInput.value = this.textContent;
                sendMessage();
            });
        });

        // Function to send message
        async function sendMessage() {
            console.log('Send message function called');
            const message = userInput.value.trim();
            if (!message) {
                console.log('Message is empty, not sending');
                return;
            }

            console.log('Sending message:', message);

            // Add user message to chat
            addMessage(message, 'user');

            // Clear input
            userInput.value = '';

            try {
                // Show typing indicator
                const typingIndicator = document.createElement('div');
                typingIndicator.className = 'message ai-message';
                typingIndicator.id = 'typing-indicator';
                typingIndicator.textContent = 'Thinking...';
                chatContainer.appendChild(typingIndicator);

                // Scroll to bottom
                chatContainer.scrollTop = chatContainer.scrollHeight;

                // Get relevant document chunks for RAG
                let documentContext = '';
                try {
                    // Only try to fetch documents if we have a valid API key and a valid documents URL
                    if (API_KEY &&
                        API_KEY !== 'pk_VBAxUh2HZZyIjC4alk7aLU5-vh8OsNlt79LFfXqGvUE' &&
                        !API_KEY.includes('{{') &&
                        !API_KEY.includes('}}') &&
                        DOCUMENTS_API_URL) {
                        console.log('Fetching documents from:', DOCUMENTS_API_URL);
                        // Set up headers for the request
                        let headers = {
                            'Content-Type': 'application/json',
                            'X-API-Key': API_KEY  // Always include X-API-Key header
                        };

                        // Also include Authorization header for backward compatibility
                        headers['Authorization'] = `Bearer ${API_KEY}`;

                        console.log('Using headers for document retrieval:', Object.keys(headers));

                        const documentsResponse = await fetch(DOCUMENTS_API_URL, {
                            method: 'GET',
                            headers: headers
                        });

                        if (documentsResponse.ok) {
                            const documents = await documentsResponse.json();
                            if (documents && documents.length > 0) {
                                // In a real implementation, we would search for relevant chunks here
                                // For now, we'll just indicate that documents are available
                                documentContext = "The user has uploaded documents. Please use them to answer the question.";
                            } else {
                                documentContext = "No documents have been uploaded yet. Please upload documents in the admin panel to enable document-based answers.";
                            }
                        } else {
                            console.warn(`Error fetching documents: ${documentsResponse.status}`);
                            documentContext = "Error fetching documents. Proceeding with general knowledge.";
                        }
                    } else if (!API_KEY) {
                        console.warn('No API key available for document retrieval');
                        documentContext = "No API key available. Proceeding with general knowledge.";
                    } else if (!DOCUMENTS_API_URL) {
                        console.warn('No valid documents URL available');
                        documentContext = "Could not determine app ID for document retrieval. Proceeding with general knowledge.";
                    }
                } catch (error) {
                    console.error('Error fetching documents:', error);
                    documentContext = "Error fetching documents. Proceeding with general knowledge.";
                }

                // The app_id should now be directly available from the template as a numeric ID
                console.log('Current APP_ID from template:', APP_ID);
                console.log('APP_ID type:', typeof APP_ID);

                // Try to extract app ID from the URL path
                const urlPath = window.location.pathname;
                const chatbotRegex = /rag-chatbot-(\d+)/;
                const chatbotMatch = urlPath.match(chatbotRegex);

                if (chatbotMatch && chatbotMatch[1]) {
                    const extractedId = parseInt(chatbotMatch[1], 10);
                    console.log('Extracted numeric app ID from URL path:', extractedId);

                    // Set APP_ID to the extracted numeric ID
                    APP_ID = extractedId.toString();
                    console.log('Setting APP_ID to extracted value from URL path:', APP_ID);
                }

                // If in iframe, try to extract from parent URL
                try {
                    if (window !== window.parent) {
                        const parentUrl = document.referrer;
                        console.log('Parent URL:', parentUrl);

                        const parentMatch = parentUrl.match(/rag-chatbot-(\d+)/);
                        if (parentMatch && parentMatch[1]) {
                            const extractedId = parseInt(parentMatch[1], 10);
                            console.log('Extracted numeric app ID from parent URL:', extractedId);

                            // Set APP_ID to the extracted numeric ID
                            APP_ID = extractedId.toString();
                            console.log('Setting APP_ID to extracted value from parent URL:', APP_ID);
                        }
                    }
                } catch (e) {
                    console.warn('Error accessing parent URL:', e);
                }

                // IMPORTANT DEBUG: Log all configuration values to see what's being passed
                console.log('All template variables:');
                console.log('- API_KEY:', API_KEY ? (API_KEY.substring(0, 4) + '...') : 'none');
                console.log('- MODEL:', MODEL);
                console.log('- TEMPERATURE:', TEMPERATURE);
                console.log('- SYSTEM_PROMPT:', SYSTEM_PROMPT.substring(0, 50) + '...');
                console.log('- APP_ID:', APP_ID);

                // Convert to number if it's a string
                let numericAppId = (typeof APP_ID === 'string') ? parseInt(APP_ID, 10) : APP_ID;

                // Verify that we have a valid numeric ID
                if (isNaN(numericAppId)) {
                    console.warn('APP_ID is not a valid number:', APP_ID);

                    // Try to get from URL query parameter as fallback
                    const urlParams = new URLSearchParams(window.location.search);
                    const appIdParam = urlParams.get('app_id');
                    if (appIdParam && !isNaN(parseInt(appIdParam, 10))) {
                        numericAppId = parseInt(appIdParam, 10);
                        console.log('Using app_id from URL query parameter:', numericAppId);
                    } else {
                        // Last resort - prompt the user (for testing only)
                        const userInput = prompt('Please enter the app ID (numeric only).\n\nThis is needed for RAG functionality to work correctly.');
                        if (userInput && !isNaN(parseInt(userInput, 10))) {
                            numericAppId = parseInt(userInput, 10);
                            console.log('Using manually entered app ID:', numericAppId);
                        } else {
                            // Don't use a hardcoded default - extract from URL path
                            const pathMatch = window.location.pathname.match(/rag-chatbot-(\d+)/);
                            if (pathMatch && pathMatch[1]) {
                                numericAppId = parseInt(pathMatch[1], 10);
                                console.log('Using app ID extracted from URL path as fallback:', numericAppId);
                            } else {
                                // Absolute last resort - use a default but log a warning
                                console.warn('Could not determine app ID from any source. RAG functionality may not work correctly.');
                            }
                        }
                    }
                }

                console.log('Using numeric app ID for RAG request:', numericAppId);

                // IMPORTANT: For testing, use the app ID from the URL if available
                const urlParams = new URLSearchParams(window.location.search);
                const urlAppId = urlParams.get('app_id');
                const appIdToUse = urlAppId ? parseInt(urlAppId, 10) : numericAppId;

                console.log('Final app ID to use in request:', appIdToUse);

                // Prepare request body for RAG API
                const ragRequestBody = {
                    query: message,
                    app_id: appIdToUse,
                    temperature: TEMPERATURE,
                    model: MODEL,
                    top_k: 5,
                    similarity_threshold: 0.7
                };

                // Make API request
                let response;
                try {
                    // Check if we have a valid API key
                    if (!API_KEY) {
                        console.error('No API key available');
                        throw new Error('No API key available');
                    }

                    // Log that we have a valid API key
                    console.log('Using API key:', API_KEY.substring(0, 4) + '...');

                    // We'll use the parsed app ID from earlier

                    // Set up headers for the request
                    let headers = {
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY  // Always include X-API-Key header
                    };

                    // Also include Authorization header for backward compatibility
                    headers['Authorization'] = `Bearer ${API_KEY}`;

                    console.log('Using headers for completion:', Object.keys(headers));

                    console.log('Making RAG API request to:', RAG_API_URL);
                    console.log('RAG Request body:', ragRequestBody);

                    // IMPORTANT DEBUG: Show the exact JSON being sent
                    console.log('RAG Request JSON:', JSON.stringify(ragRequestBody, null, 2));

                    // Try to make the request to the current origin first
                    try {
                        console.log('Attempting to call RAG API on current origin');
                        response = await fetch(RAG_API_URL, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify(ragRequestBody)
                        });
                        console.log('RAG API response status:', response.status);
                    } catch (fetchError) {
                        console.error('Error calling RAG API on current origin:', fetchError);

                        // If that fails, try the backend server directly
                        console.log('Attempting to call RAG API on backend server directly');
                        const backendUrl = 'http://localhost:8000/api/v1/llm/rag';
                        response = await fetch(backendUrl, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify(ragRequestBody)
                        });
                        console.log('RAG API response status (backend):', response.status);
                    }

                    console.log('API response status:', response.status);

                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }
                } catch (error) {
                    console.error('Error making API request:', error);
                    throw error;
                }

                // Remove typing indicator
                const indicator = document.getElementById('typing-indicator');
                if (indicator) {
                    chatContainer.removeChild(indicator);
                }

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                console.log('RAG API response:', data);

                if (data.answer) {
                    // This is a RAG response
                    // Pass the sources to the addMessage function
                    addMessage(data.answer, 'ai', data.sources);

                    // Log sources for debugging
                    if (data.sources && data.sources.length > 0) {
                        console.log('Sources used for answer:', data.sources);
                    }
                } else if (data.choices && data.choices.length > 0) {
                    // This is a standard completions response
                    const aiMessage = data.choices[0].message.content;
                    addMessage(aiMessage, 'ai');
                } else {
                    addMessage('No response received. Please try again.', 'ai');
                }
            } catch (error) {
                console.error('Error:', error);

                // Remove typing indicator
                const indicator = document.getElementById('typing-indicator');
                if (indicator) {
                    chatContainer.removeChild(indicator);
                }

                // Show error message
                addMessage('Sorry, I encountered an error. Please try again.', 'ai');
            }
        }

        // Function to add message to chat
        function addMessage(text, sender, sources = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;

            // Process markdown-like formatting
            let formattedText = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // Bold
                .replace(/\*(.*?)\*/g, '<em>$1</em>')              // Italic
                .replace(/`(.*?)`/g, '<code>$1</code>')            // Code
                .replace(/\n/g, '<br>');                           // Line breaks

            messageDiv.innerHTML = formattedText;

            // Add sources if available (only for AI messages)
            if (sender === 'ai' && sources && sources.length > 0) {
                const sourcesContainer = document.createElement('div');
                sourcesContainer.className = 'sources-container';

                // Create toggle button for sources
                const sourcesToggle = document.createElement('div');
                sourcesToggle.className = 'sources-toggle';
                sourcesToggle.innerHTML = '📚 What is my answer based on?';
                sourcesToggle.addEventListener('click', function() {
                    const sourcesList = this.nextElementSibling;
                    sourcesList.classList.toggle('expanded');

                    // Change text based on expanded state
                    if (sourcesList.classList.contains('expanded')) {
                        this.innerHTML = '📚 Hide source documents';
                    } else {
                        this.innerHTML = '📚 What is my answer based on?';
                    }
                });

                // Create sources list
                const sourcesList = document.createElement('div');
                sourcesList.className = 'sources-list';

                // Add explanation heading
                const sourcesExplanation = document.createElement('div');
                sourcesExplanation.className = 'sources-explanation';
                sourcesExplanation.innerHTML = 'Below documents were used to generate this answer. Click on a document to see the specific paragraphs.';
                sourcesList.appendChild(sourcesExplanation);

                // Group sources by document name
                const groupedSources = {};

                sources.forEach((source, index) => {
                    // Get document name from metadata
                    const docName = source.metadata && source.metadata.document_name
                        ? source.metadata.document_name
                        : `Source ${index + 1}`;

                    // Create the group if it doesn't exist
                    if (!groupedSources[docName]) {
                        groupedSources[docName] = [];
                    }

                    // Add the source to its group
                    groupedSources[docName].push(source);
                });

                // Add each document group
                Object.entries(groupedSources).forEach(([docName, docSources]) => {
                    const sourceItem = document.createElement('div');
                    sourceItem.className = 'source-item';

                    // Create source name/header
                    const sourceName = document.createElement('div');
                    sourceName.className = 'source-name';

                    // Show document name with paragraph count
                    sourceName.innerHTML = `<span>${docName} (${docSources.length} ${docSources.length === 1 ? 'paragraph' : 'paragraphs'})</span><span>▼</span>`;

                    // Create container for all chunks from this document
                    const chunksContainer = document.createElement('div');
                    chunksContainer.className = 'source-chunks-container';

                    // Toggle chunks container visibility on click
                    sourceName.addEventListener('click', function() {
                        chunksContainer.classList.toggle('expanded');

                        // Change arrow direction
                        const arrow = this.querySelector('span:last-child');
                        if (chunksContainer.classList.contains('expanded')) {
                            arrow.textContent = '▲';
                        } else {
                            arrow.textContent = '▼';
                        }
                    });

                    // Add each chunk from this document
                    docSources.forEach((source, chunkIndex) => {
                        // Create chunk container
                        const chunkItem = document.createElement('div');
                        chunkItem.className = 'source-chunk';

                        // Add paragraph number if there are multiple paragraphs
                        if (docSources.length > 1) {
                            const chunkHeader = document.createElement('div');
                            chunkHeader.className = 'chunk-header';
                            chunkHeader.textContent = `Paragraph ${chunkIndex + 1}`;
                            chunkItem.appendChild(chunkHeader);
                        }

                        // Create source content with markdown formatting
                        const sourceContent = document.createElement('div');
                        sourceContent.className = 'source-content';

                        // Clean up the text - remove document IDs and clean up formatting
                        let cleanText = source.text;

                        // Remove document ID lines (lines starting with # followed by alphanumeric characters and hyphens)
                        cleanText = cleanText.replace(/^#\s*[a-zA-Z0-9\-]+\.pdf.*$/m, '');

                        // Apply the same markdown formatting we use for messages
                        let formattedSourceText = cleanText
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // Bold
                            .replace(/\*(.*?)\*/g, '<em>$1</em>')              // Italic
                            .replace(/`(.*?)`/g, '<code>$1</code>')            // Code
                            .replace(/\n/g, '<br>');                           // Line breaks

                        // Remove any empty lines at the beginning
                        formattedSourceText = formattedSourceText.replace(/^(<br>)+/, '');

                        sourceContent.innerHTML = formattedSourceText;

                        // Add content to chunk
                        chunkItem.appendChild(sourceContent);

                        // Add chunk to chunks container
                        chunksContainer.appendChild(chunkItem);
                    });

                    // Add to source item
                    sourceItem.appendChild(sourceName);
                    sourceItem.appendChild(chunksContainer);

                    // Add to sources list
                    sourcesList.appendChild(sourceItem);
                });

                // Add toggle and list to container
                sourcesContainer.appendChild(sourcesToggle);
                sourcesContainer.appendChild(sourcesList);

                // Add sources container to message
                messageDiv.appendChild(sourcesContainer);
            }

            chatContainer.appendChild(messageDiv);

            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    </script>
</body>
</html>
